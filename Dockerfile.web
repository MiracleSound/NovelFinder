FROM node:18-alpine AS build
WORKDIR /app

COPY package.json pnpm-workspace.yaml tsconfig.base.json ./
COPY apps/web/package.json apps/web/tsconfig.json apps/web/tsconfig.node.json apps/web/vite.config.ts apps/web/tailwind.config.ts apps/web/postcss.config.cjs ./
COPY apps/web/src ./apps/web/src
COPY apps/web/index.html ./apps/web/index.html

RUN corepack enable && pnpm install --filter web --frozen-lockfile && pnpm --filter web build

FROM nginx:1.27-alpine AS prod
WORKDIR /usr/share/nginx/html
COPY --from=build /app/apps/web/dist ./
COPY --from=build /app/apps/web/dist ./dist

# Basic nginx config for SPA
RUN rm /etc/nginx/conf.d/default.conf
COPY <<'NGINX' /etc/nginx/conf.d/default.conf
server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  location / {
    try_files $uri /index.html;
  }
}
NGINX

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
